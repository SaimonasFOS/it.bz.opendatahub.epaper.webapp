<template>
  <b-form @submit.prevent="submitTemplate">
    <div class="editor">
      <b-card :title="pageTitle" class="form_card">
        <b-card-text>
          <b-form-input
            v-model="name"
            label="Name"
            placeholder="Enter a name"
          />
          <b-form-input
            v-model="description"
            label="Description"
            placeholder="Enter a description"
          />
          <b-form-file v-model="image" accept="image/*"></b-form-file>
          <b-card>
            <b-card-text>
              <ImageFields v-model="imageFields"></ImageFields>
            </b-card-text>
          </b-card>
        </b-card-text>
      </b-card>
      Template image preview
      <ImagePreview
        class="image_preview"
        :imageSrc="imageSrc"
        :imageFields="imageFields"
      ></ImagePreview>
    </div>
    <div>
      <b-button variant="danger" to="/templates" class="mt-2 mr-2">
        Cancel
      </b-button>
      <b-button variant="success" type="submit" class="mt-2">
        Save template
      </b-button>
    </div>
  </b-form>
</template>

<script>
import toastPresets from "@/utils/toastPresets.js";
import ImageFields from "@/components/displayContent/ImageFields.vue";
import ImagePreview from "@/components/displayContent/ImagePreview.vue";

export default {
  props: {
    editMode: Boolean,
    initialName: String,
    initialDescription: String,
    initialImageFields: Array,
    templateId: String,
  },
  components: {
    ImageFields,
    ImagePreview,
  },
  data() {
    return {
      name: this.initialName,
      description: this.initialDescription,
      image: null,
      imageFields: this.initialImageFields || [],
    };
  },
  computed: {
    pageTitle() {
      return this.editMode ? "Edit template" : "Add template";
    },
    imageSrc() {
      return this.editMode && !this.image
        ? `${this.$store.state.URI}/template/getImage/${
            this.templateId
          }?x=${Date.now()}`
        : this.image;
    },
  },

  methods: {
    submitTemplate() {
      const { name, description, imageFields, image } = this;
      const data = {
        image,
        template: {
          name,
          description,
          displayContent: {
            imageFields,
          },
        },
      };

      let storeOperation;
      if (this.editMode) {
        storeOperation = "updateTemplate";
        data.template.uuid = this.templateId;
      } else {
        storeOperation = "createTemplate";
      }

      this.$store
        .dispatch(storeOperation, data)
        .then(() => this.$router.replace("templates"))
        .catch(() => {
          this.$bvToast.toast(
            "Failed to save template",
            toastPresets.errorMessage
          );
        });
    },
  },
};
</script>

<style scoped>
.editor {
  overflow: auto;
}
.form_card {
  width: 60%;
  float: left;
  margin-bottom: 5px;
}
.image_preview {
  width: 38%;
}

/* Responsive layout - makes a one column-layout instead of two-column layout */
@media (max-width: 1200px) {
  .form_card {
    width: 100%;
  }
  .image_preview {
    width: 100%;
  }
}
</style>